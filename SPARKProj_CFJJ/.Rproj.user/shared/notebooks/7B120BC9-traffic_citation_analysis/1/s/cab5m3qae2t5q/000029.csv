"0","cleandata <- function(year) {"
"0","  home <- ""~/johnsonlab/aodom/cs506/SPARKProj_CFJJ/ds-cfjj-police-accountability/Team1/Data/DOT_Citations_data/"""
"0","  pathname <- paste(home,"
"0","                    ""sqr 21318 MRP all citations for "", year, "".csv"","
"0","                    sep = """")"
"0","  # Specify column types"
"0","  coltypes <- cols("
"0","    `Issuing Agency` = col_character(),"
"0","    `Agency Code` = col_character(),"
"0","    OfficerID = col_character(),"
"0","    `Event Date` = col_datetime(format = """"),"
"0","    `Time-HH` = col_character(),"
"0","    `Time-MM` = col_character(),"
"0","    `AM-PM` = col_character(),"
"0","    `Viol Type` = col_character(),"
"0","    `Citation #` = col_character(),"
"0","    `Citation Type` = col_character(),"
"0","    Offense = col_character(),"
"0","    `Offense Description` = col_character(),"
"0","    `Location Name` = col_character(),"
"0","    Searched = col_character(),"
"0","    `Crash?` = col_character(),"
"0","    `Court Code` = col_character(),"
"0","    Race = col_character(),"
"0","    Gender = col_character(),"
"0","    `Year of Birth` = col_integer(),"
"0","    `Lic State` = col_character(),"
"0","    `Lic Class` = col_character(),"
"0","    CDL = col_character(),"
"0","    PlateType = col_character(),"
"0","    `Vhc State` = col_character(),"
"0","    `Vhc Year` = col_integer(),"
"0","    `Make Model` = col_character()"
"0","  )"
"0","  # Read in whole csv (with errors)"
"0","  allyear_test <- read_csv(pathname, col_types = coltypes,"
"0","                           show_col_types = FALSE)"
"0","  # Read in values with only two columns"
"0","  knot <- read_delim(pathname, skip = 1, delim = ""ยง"", col_names = FALSE,"
"0","                     show_col_types = FALSE)"
"0","  # Separate values in each column"
"0","  pre_knot <- read_csv(I(knot$X1), col_names = FALSE, show_col_types = FALSE)"
"0","  knot_fixed <- read_csv(I(knot$X2), col_names = FALSE, show_col_types = FALSE)"
"0","  # Replace values in OG data with corrected columns"
"0","  allyear_test$`Offense Description` <- paste(pre_knot$X12, knot_fixed$X1,"
"0","                                              sep = "" ยง"")"
"0","  allyear_test[, 13:ncol(allyear_test)] <- knot_fixed[, -1]"
"0","  # Export data"
"0","  allyear_test %<>%"
"0","    select(-c(`Time-MM`, `Agency Code`, `Lic Class`, CDL, PlateType,"
"0","              `Vhc Year`, `Lic State`)) %>%"
"0","    mutate(`AM-PM` = replace(`AM-PM`, `AM-PM` == ""UNK"", NA),"
"0","           Gender = replace(`Gender`, `Gender` == ""UNK"", NA),"
"0","           Race = replace(`Race`, `Race` == ""UNK"", NA))"
"0","  rm(knot, pre_knot, knot_fixed)"
"0","  # Change time of day ""unk"" to NA"
"0","  # Group citation number within agency"
"0","  message(""Merging files"")"
"0","  read_law <- paste(home,"
"0","                    ""LawEnforcementMisconductDatabase_11_17_21_cpcs.csv"","
"0","                    sep = """")"
"0","  lawenf <- readr::read_csv(read_law, show_col_types = FALSE) %>%"
"0","    select(-c(Notes))"
"0","  # We want which officers are making which stops"
"0","  # Remove anything with nas in issuing agency, officer ID"
"0","  to_rep <- c(""Dept"" = ""Department"","
"0","              ""Pd"" = ""Police Department"","
"0","              ""Cnty"" = ""County"", ""Hosp"" = ""Hospital"","
"0","              ""W "" = ""West "", ""E "" = ""East "", ""N "" = ""North "", ""S "" = ""South "")"
"0","  allyear_filt <- allyear_test %>%"
"0","    mutate(`Issuing Agency` = str_remove_all(str_to_title(`Issuing Agency`),"
"0","                                             ""\\.""),"
"0","           `Issuing Agency` = str_replace_all(`Issuing Agency`, to_rep),"
"0","           OfficerID = as.numeric(str_remove_all(OfficerID, ""[^0-9]""))) %>%"
"0","    mutate(`Issuing Agency` = str_remove_all(`Issuing Agency`,"
"0","                                             ""\\b Police Department\\b""),"
"0","           `Issuing Agency` = replace(`Issuing Agency`,"
"0","                                      str_detect(`Issuing Agency`,"
"0","                                                 ""\\bBoston Police\\b""),"
"0","                                      ""Boston""),"
"0","           `Issuing Agency` = replace(`Issuing Agency`,"
"0","                                      str_detect(`Issuing Agency`,"
"0","                                                 ""\\bState Police\\b""),"
"0","                                      ""Massachusetts State Police""))"
"0","  allyear_filt$uniqueobs <- seq_len(nrow(allyear_filt))"
"0","  "
"0","  lawenf_filt <- lawenf %>%"
"0","  mutate(`Issuing Agency` = str_remove_all(`Agency`,"
"0","                                           ""\\b Police Department\\b""),"
"0","         `Badge Num` = as.numeric(str_remove_all(`Badge Num`, ""[^0-9]"")),"
"0","         `Employee ID` = as.numeric(str_remove_all(`Employee ID`, ""[^0-9]""))) %>%"
"0","  filter((!is.na(`Employee ID`) | !is.na(`Badge Num`)))"
"0","  #- --------------------------"
"0","  # Approach 1: Merge on whatever is larger"
"0","  larger <- lawenf_filt %>% group_by(`Issuing Agency`) %>%"
"0","  summarise(num_badge = length(unique(`Badge Num`)),"
"0","            num_id = length(unique(`Employee ID`))) %>%"
"0","    select(num_id, num_badge) %>%"
"0","    apply(., 1, which.max) %>% unlist %>% as_tibble() %>%"
"0","    mutate(`Issuing Agency` = unique(lawenf_filt$`Issuing Agency`))"
"0","  pt1 <- lawenf_filt %>% left_join(., larger, by = ""Issuing Agency"") %>%"
"0","    filter(value == 1, !is.na(`Employee ID`)) %>% mutate(OfficerID = `Employee ID`)"
"0","  pt2 <- lawenf_filt %>% left_join(., larger, by = ""Issuing Agency"") %>%"
"0","    filter(value == 2, !is.na(`Badge Num`)) %>% mutate(OfficerID = `Badge Num`)"
"0","  all_entries_A1 <- dplyr::bind_rows(pt1, pt2) %>%"
"0","    group_by(`Issuing Agency`) %>% distinct(OfficerID, .keep_all = TRUE) %>%"
"0","    inner_join(., allyear_filt, by = c(""Issuing Agency"", ""OfficerID""))"
"0","    # mutate(`DOT Identifier` = ""Employee ID"")"
"0","  # Approach 2: Merge on whatever else"
"0","  lawenf_filt1 <- lawenf_filt %>%"
"0","    filter(!(`Internal Unique ID` %in% all_entries_A1$`Internal Unique ID`))"
"0","  pt3 <- lawenf_filt1 %>% left_join(., larger, by = ""Issuing Agency"") %>%"
"0","    filter(value == 1, !is.na(`Badge Num`)) %>% mutate(OfficerID = `Badge Num`)"
"0","  pt4 <- lawenf_filt1 %>% left_join(., larger, by = ""Issuing Agency"") %>%"
"0","    filter(value == 2, !is.na(`Employee ID`)) %>% mutate(OfficerID = `Employee ID`)"
"0","  all_entries_A2 <-  dplyr::bind_rows(pt3, pt4) %>%"
"0","    group_by(`Issuing Agency`) %>% distinct(OfficerID, .keep_all = TRUE) %>%"
"0","    inner_join(., allyear_filt, by = c(""Issuing Agency"", ""OfficerID"")) %>%"
"0","    filter(!(uniqueobs %in% all_entries_A1$uniqueobs))"
"0","  # FINAL BINDING"
"0","  unique_allentries <- allyear_filt %>%"
"0","    filter(!(uniqueobs %in% unique(c(all_entries_A1$uniqueobs,"
"0","                                     all_entries_A2$uniqueobs))))"
"0","  all_entries <- bind_rows(unique_allentries, all_entries_A1, all_entries_A2) %>%"
"0","    mutate(`MassDOT ID` = OfficerID) %>%"
"0","    select(-OfficerID, -uniqueobs) %>%"
"0","    arrange(`Event Date`)"
"0","  to_save <- paste(home, ""DOT"", year, ""merged.csv"", sep = """")"
"0","  message(""writing merged file to"", to_save)"
"0","  write.csv(all_entries, to_save)"
"0","  return(all_entries)"
"0","}"
